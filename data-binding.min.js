var Expression=function(){function e(){this.match=function(e){return null!==e.replace(/\s/g,"").match(/^\s*{{\s*[\w._]+((.+?))?(:\w+)?\s*}}\s*$/)},this.name=function(e){return e.replace(/\s/g,"").match(/^{{[\w._]+(\(.+?\))?(:\w+)?/)[0].replace(/^{{/,"")},this.params=function(e){return e.replace(/\s/g,"").match(/\(.+?\)/)[0].replace(/[()]/g,"").split(",")}}return e}(),Events=function(){function e(e,t){for(var n=t.querySelectorAll("*[event]"),r=0;r<n.length;++r)this.bindEvent(e,n[r])}return e.prototype.bindEvent=function(e,t){var n=t.attributes.event.value.split(":"),r=n[1];t.addEventListener(r,function(t){var r=n[0];if(r=e[r],!r){var i=r.split(".");for(r=e[i[0]],i.splice(0,1);i.length>0;)r=r[i[0]],i.splice(0,1)}r.apply(void 0,[t])})},e}(),Template=function(){function e(e,t){if(t)for(var n=t.querySelectorAll("template"),r=0,i=n.length;i>r;r++){var o=n[r];o.getAttribute("repeat")&&this.repeat(e,o),"true"===o.getAttribute("show")&&this.show(e,o),"false"===o.getAttribute("hide")&&this.hide(e,o)}}return e.prototype.copyElements=function(e,t){for(var n=[],r=0;r<e.length;r++){var i=e[r],o=i.cloneNode();o.innerHTML=i.innerHTML,n.push(o),t.appendChild(o)}return n},e.prototype.deletePrev=function(e,t){var n=e.previousElementSibling;n&&n.attributes[t]===!0&&n.parentNode.removeChild(n)},e.prototype.repeat=function(t,n){var r=n.content.querySelectorAll("*"),i=(new Bind).getValue(t,n.attributes.repeat.value),o=document.createElement("div");console.log(n),o.attributes.repeat=!0;for(var a=0;a<i.length;a++){var s,l,c=i[a];t._item=c,t._index=a,u=new Refrences(this.copyElements(r,o)).find(t),s=u[0],l=u[1],new Bind(t,s)}t._item=void 0,t._index=void 0,new Events(t,o),new e(t,o),this.deletePrev(n,"repeat"),n.parentNode.insertBefore(o,n);var u},e.prototype.show=function(e,t){"true"===t.attributes.show.value?this.stampTemplate(e,t,"show"):this.deletePrev(t,"show")},e.prototype.hide=function(e,t){"false"===t.attributes.hide.value?this.stampTemplate(e,t,"hide"):this.deletePrev(t,"hide")},e.prototype.stampTemplate=function(t,n,r){{var i,o,a=document.createElement("div"),s=n.content.querySelectorAll("*");new Bind}a.attributes[r]=!0,l=new Refrences(this.copyElements(s,a)).find(t),i=l[0],o=l[1],new Bind(t,i),new Events(t,a),new e(t,a),this.deletePrev(n,r),n.parentNode.insertBefore(a,n);var l},e}(),Refrences=function(){function e(e){this.Elements=e}return e.prototype.find=function(e){function t(t){var o=n.name(t.innerHTML?t.innerHTML:t.value);try{var a=n.params(t.innerHTML);a.forEach(function(e){i[e]?i[e].push(t.innerHTML):i[e]=[t.innerHTML]})}catch(s){}var l=o.split(":");l.length>1&&t.ownerElement.addEventListener(l[1],function(){(new Bind).setValue(e,l[0],this.value)}),o=l[0],r[o]?r[o].push(t):r[o]=[t]}for(var n=new Expression,r={},i={},o=0,a=this.Elements.length;a>o;o++){var s=this.Elements[o];n.match(s.innerHTML)&&t(s);for(var l=0,c=s.attributes.length;c>l;l++){var u=s.attributes[l];"repeat"===u.name&&(r[u.value]?r[u.value].push(s):r[u.value]=[s]),n.match(u.value)&&t(u)}}return[r,i]},e}(),Bind=function(){function e(e,t){if(e&&t)for(var n in t)for(var r=t[n],i=0,o=r.length;o>i;i++){var a=r[i];"TEMPLATE"!==a.tagName&&this.element(this.getValue(e,n),a)}}return e.prototype.setValue=function(e,t,n){if(void 0===e[t]){var r=t.split(".");for(e=e[r[0]],r.splice(0,1);r.length>1;)e=e[r[0]],r.splice(0,1);t=r[0]}e[t]=n},e.prototype.getValue=function(e,t){var n=e[t],r=this;if(null!==t.match(/\(.+?\)/)&&void 0===n){var i=new Expression,o=i.name("{{"+t).match(/^[\w._]+/)[0],a=i.params(t);a.forEach(function(t,n){a[n]=r.getValue(e,t)}),n=r.getValue(e,o).apply(void 0,a)}else if(void 0===n){var s=t.split(".");for(n=e[s[0]],s.splice(0,1);s.length>0;)n=n[s[0]],s.splice(0,1)}return n},e.prototype.element=function(e,t){void 0!==t.innerHTML?t.innerHTML=e:t.value=e},e.prototype.change=function(e,t,n,r,i){var o,a,s=(i?i:"")+t.name,l=t.object[t.name],c=new Template,u=this;if(s=s.replace(/\.\d+$/,""),o=n[s],a=r[s],"length"!==t.name){if(o)for(var p=0,v=o.length;v>p;++p){var h=o[p];"TEMPLATE"===h.tagName?c.repeat(e,h):(u.element(l,h),"show"===h.name?c.show(e,h.ownerElement):"hide"===h.name&&c.hide(e,h.ownerElement))}if(a)for(var p=0,v=a.length;v>p;++p)for(var d=f.replace(/[{}\s]/g,""),m=n[d],w=0,g=m.length;g>w;++w)u.element(u.getValue(e,d),m[w])}},e}(),Model=function(){function e(e,t){var n=this;if(this.Object=e,t=t||document.body,this.Scope=t,"object"!=typeof this.Object)throw"a view model object must be defined";return new Promise(function(e){r=new Refrences(t.querySelectorAll("*")).find(n.Object),n.Refrences=r[0],n.Functions=r[1],n.observe(n.Object),new Bind(n.Object,n.Refrences),new Events(n.Object,t),new Template(n.Object,t),e();var r})}return e.prototype.observe=function(e,t){var n=this,r=new Bind;Object.observe(e,function(e){for(var i=0,o=e.length;o>i;++i)r.change(n.Object,e[i],n.Refrences,n.Functions,t)});for(var i in e)"object"==typeof e[i]&&n.observe(e[i],(t?t:"")+i+".")},e}();